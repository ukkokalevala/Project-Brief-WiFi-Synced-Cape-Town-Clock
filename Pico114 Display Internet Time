/*
 * WiFi NTP Clock for ESP8266 & Waveshare Pico 1.14" Display
 * Configured for Cape Town, South Africa (SAST, UTC+2)
 * Uses Adafruit_ST7789 & Adafruit_GFX libraries
 */

#include <Adafruit_GFX.h>
#include <Adafruit_ST7789.h>
#include <SPI.h>
#include <ESP8266WiFi.h>
#include <WiFiUdp.h>
#include <NTPClient.h>
#include <TimeLib.h>

// ===================== DISPLAY SETUP =====================
#define TFT_CS   D2
#define TFT_RST  D4
#define TFT_DC   D3
Adafruit_ST7789 tft = Adafruit_ST7789(TFT_CS, TFT_DC, TFT_RST);

// ===================== WIFI & NTP SETUP =====================
const char* ssid     = "YOUR_SSID";   // <-- CHANGE THIS
const char* password = "YOUR_PASSWORD";   // <-- CHANGE THIS

WiFiUDP ntpUDP;
// Cape Town uses SAST (UTC+2) with no daylight saving
// Using South Africa's NTP pool for potentially better accuracy
NTPClient timeClient(ntpUDP, "za.pool.ntp.org", 7200, 60000);

// Time variables
char timeString[9];
char dateString[11];
int lastSecond = -1;
bool timeSynced = false;
unsigned long lastFullUpdate = 0; // Tracks last full NTP sync

// ===================== SETUP FUNCTION =====================
void setup() {
  Serial.begin(115200);
  
  // 1. Initialize Display
  tft.init(135, 240);     // Try (135, 240) if display is sideways
  tft.setRotation(3);
  tft.fillScreen(ST77XX_BLACK);
  
  displayStartupMessage();
  
  // 2. Connect to WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
    static bool dot = false;
    tft.fillCircle(120, 100, 3, dot ? ST77XX_BLACK : ST77XX_WHITE);
    dot = !dot;
  }
  Serial.println("\nWiFi connected!");
  
  // 3. Start NTP client
  timeClient.begin();
  
  // 4. Perform initial time sync
  timeClient.forceUpdate(); // Get accurate time immediately
  lastFullUpdate = millis();
  
  // 5. Clear screen and draw static UI
  tft.fillScreen(ST77XX_BLACK);
  drawStaticUI();
}

// ===================== MAIN LOOP =====================
void loop() {
  // Update NTP time (adjusts internal clock drift)
  timeClient.update();
  
  // === 24-HOUR SYNCHRONIZATION CODE ===
  // Force a full NTP server sync every 24 hours to prevent drift
  if (millis() - lastFullUpdate > 86400000UL) { // 86400000 ms = 24 hours
    timeClient.forceUpdate(); // Fresh network request
    lastFullUpdate = millis();
    Serial.println("Forced full NTP synchronization.");
  }
  
  // Check if we have a new second
  int currentSecond = timeClient.getSeconds();
  
  if (currentSecond != lastSecond) {
    lastSecond = currentSecond;
    timeSynced = true;
    
    // Format time and date
    formatTime(timeClient.getEpochTime());
    
    // Update the display
    updateDisplay();
  }
  
  delay(50);
}

// ===================== DISPLAY FUNCTIONS =====================
void displayStartupMessage() {
  tft.setTextColor(ST77XX_GREEN);
  tft.setTextSize(2);
  tft.setCursor(40, 50);
  tft.println("CAPE TOWN");
  tft.setCursor(60, 75);
  tft.println("CLOCK");
  tft.setTextSize(1);
  tft.setCursor(50, 100);
  tft.println("SAST | UTC+2");
  delay(2000);
}

void drawStaticUI() {
  // Draw a border
  tft.drawRect(5, 5, 230, 125, ST77XX_WHITE);
  
  // Draw title
  tft.setTextColor(ST77XX_CYAN);
  tft.setTextSize(2);
  tft.setCursor(70, 15);
  tft.println("CAPE TOWN");
  tft.setCursor(90, 35);
  tft.println("TIME");
  
  // Draw labels
  tft.setTextColor(ST77XX_YELLOW);
  tft.setTextSize(1);
  tft.setCursor(20, 105);
  tft.print("Date:");
  tft.setCursor(20, 120);
  tft.print("Time:");
}

void updateDisplay() {
  if (!timeSynced) return;
  
  // Update TIME (large font)
  tft.setTextColor(ST77XX_GREEN, ST77XX_BLACK);
  tft.setTextSize(4);
  tft.setCursor(50, 60);
  
  char hourMinString[6];
  sprintf(hourMinString, "%02d:%02d", timeClient.getHours(), timeClient.getMinutes());
  tft.println(hourMinString);
  
  // Update DATE
  tft.setTextColor(ST77XX_WHITE, ST77XX_BLACK);
  tft.setTextSize(2);
  tft.setCursor(70, 100);
  tft.println(dateString);
  
  // Show seconds
  tft.setTextSize(2);
  tft.setCursor(180, 68);
  tft.printf("%02d", timeClient.getSeconds());
  
  // Show sync indicator if full sync happened recently
  if (millis() - lastFullUpdate < 2000) { // Show for 2 seconds after sync
    tft.fillCircle(225, 20, 2, ST77XX_YELLOW); // Small yellow dot
  } else {
    tft.fillCircle(225, 20, 2, ST77XX_BLACK); // Clear the dot
  }
  
  // Show WiFi status
  drawWiFiStatus();
}

void drawWiFiStatus() {
  int x = 210, y = 15;
  tft.fillRect(x, y, 20, 12, ST77XX_BLACK);
  
  if (WiFi.status() == WL_CONNECTED) {
    tft.drawCircle(x+10, y+10, 3, ST77XX_GREEN);
    tft.drawCircle(x+10, y+10, 6, ST77XX_GREEN);
    tft.drawCircle(x+10, y+10, 9, ST77XX_GREEN);
  } else {
    tft.setTextColor(ST77XX_RED, ST77XX_BLACK);
    tft.setTextSize(1);
    tft.setCursor(x, y);
    tft.print("X");
  }
}

void formatTime(unsigned long epochTime) {
  sprintf(dateString, "%02d-%02d-%04d", 
          day(epochTime), month(epochTime), year(epochTime));
  
  sprintf(timeString, "%02d:%02d:%02d", 
          timeClient.getHours(), timeClient.getMinutes(), timeClient.getSeconds());
}
